<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ライン外作業タイマー記録</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    :root {
      --accent: #007aff;
      --accent-light: #e5f0ff;
      --danger: #ff3b30;
      --bg: #f5f5f7;
      --card: #ffffff;
      --border: #d1d1d6;
      --text-main: #111111;
      --text-sub: #6e6e73;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    .app {
      max-width: 900px;
      margin: 0 auto;
      padding: 12px 12px 40px;
    }

    h1 {
      font-size: 20px;
      margin: 4px 4px 16px;
      font-weight: 700;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin: 16px 4px 8px;
      color: var(--text-sub);
    }

    .card {
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.06);
      padding: 12px;
      margin-bottom: 16px;
    }

    /* レイアウト：スマホは縦一列、横幅が広ければ左右2カラム */
    .layout {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    @media (min-width: 720px) {
      .layout {
        flex-direction: row;
        align-items: flex-start;
      }
      .left-column {
        flex: 0 0 260px;
      }
      .right-column {
        flex: 1;
      }
    }

    /* 作業ボタン */
    .task-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .task-btn {
      flex: 1 1 calc(50% - 8px);
      min-width: 120px;
      padding: 10px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f2f2f7;
      font-size: 14px;
      text-align: center;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: background 0.15s, border-color 0.15s, transform 0.07s;
    }

    .task-btn:active {
      transform: scale(0.97);
    }

    .task-btn.selected {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    .task-edit-toggle {
      margin-top: 8px;
      font-size: 12px;
      color: var(--accent);
      text-align: right;
      cursor: pointer;
    }

    .task-edit-area {
      margin-top: 8px;
      display: none;
    }

    .task-edit-area textarea {
      width: 100%;
      min-height: 80px;
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 8px;
      font-size: 13px;
      resize: vertical;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f2f2f7;
      padding: 6px 10px;
      font-size: 13px;
      width: 100%;
    }

    input[type="text"] {
      border: none;
      background: transparent;
      width: 100%;
      outline: none;
      font-size: 14px;
    }

    /* ボタン */
    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .btn {
      flex: 1;
      padding: 12px;
      border-radius: 999px;
      border: none;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: opacity 0.15s, transform 0.07s, box-shadow 0.15s;
    }

    .btn:active:not(:disabled) {
      transform: scale(0.97);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
    }

    .btn-start {
      background: var(--accent);
      color: #fff;
    }

    .btn-stop {
      background: var(--danger);
      color: #fff;
    }

    .btn:disabled {
      opacity: 0.35;
      cursor: default;
      box-shadow: none;
    }

    /* ステータス */
    .status {
      font-size: 13px;
      color: var(--text-sub);
      margin-top: 4px;
    }

    /* 記録エリア */
    textarea.log {
      width: 100%;
      min-height: 160px;
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 10px;
      font-size: 13px;
      resize: vertical;
    }

    .copy-btn {
      margin-top: 8px;
      width: 100%;
      border-radius: 999px;
      padding: 10px;
      border: none;
      background: var(--accent-light);
      color: var(--accent);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }

    .copy-btn:active {
      transform: scale(0.97);
    }

    .small {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>ライン外作業タイマー記録</h1>

    <div class="layout">
      <!-- 左側：要素作業・作業者名・開始/終了ボタン -->
      <div class="left-column">
        <div class="card">
          <div class="section-title">要素作業</div>
          <div id="taskButtons" class="task-buttons"></div>
          <div class="task-edit-toggle" id="taskEditToggle">＋ 要素リストを編集</div>

          <div class="task-edit-area" id="taskEditArea">
            <div class="small">1行に1つずつ作業名を入力してください（例：部品運搬）</div>
            <textarea id="taskListInput"></textarea>
            <button class="copy-btn" id="saveTaskListBtn">要素リストを保存</button>
          </div>
        </div>

        <div class="card">
          <div class="section-title">作業者名（任意）</div>
          <div class="pill">
            <input type="text" id="workerName" value="Aさん" />
          </div>

          <div class="btn-row">
            <button id="startBtn" class="btn btn-start">▶ START（計測開始）</button>
          </div>
          <div class="btn-row">
            <button id="stopBtn" class="btn btn-stop" disabled>■ STOP &amp; 記録</button>
          </div>
          <div id="status" class="status">待機中</div>
        </div>
      </div>

      <!-- 右側：ログ表示 -->
      <div class="right-column">
        <div class="card">
          <div class="section-title">記録（このままExcelに貼り付け可）</div>
          <textarea id="logArea" class="log"></textarea>
          <button id="copyAllBtn" class="copy-btn">全コピー（Excel貼り付け用）</button>
          <div class="small">
            出力形式：<br />
            要素作業,開始時刻,終了時刻,計測秒,計測日,作業者
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== 初期の要素作業（ローカルストレージに保存可能） =====
    const DEFAULT_TASKS = [
      "部品運搬",
      "品番確認",
      "棚番検索",
      "フォークリフト待ち",
      "製品仮置き",
      "手直し作業",
      "社員呼び出し"
    ];

    const TASKS_KEY = "lineTimerTasks";

    const taskButtonsContainer = document.getElementById("taskButtons");
    const taskEditToggle = document.getElementById("taskEditToggle");
    const taskEditArea = document.getElementById("taskEditArea");
    const taskListInput = document.getElementById("taskListInput");
    const saveTaskListBtn = document.getElementById("saveTaskListBtn");

    const workerNameInput = document.getElementById("workerName");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const statusEl = document.getElementById("status");
    const logArea = document.getElementById("logArea");
    const copyAllBtn = document.getElementById("copyAllBtn");

    let currentTask = "";
    let startTime = null;

    // ---- 要素リストの読み込み & レンダリング ----
    function loadTasks() {
      const saved = localStorage.getItem(TASKS_KEY);
      if (saved) {
        try {
          const list = JSON.parse(saved);
          if (Array.isArray(list) && list.length > 0) {
            return list;
          }
        } catch (e) {
          console.warn("tasks parse error", e);
        }
      }
      return DEFAULT_TASKS;
    }

    let tasks = loadTasks();

    function renderTaskButtons() {
      taskButtonsContainer.innerHTML = "";
      tasks.forEach((task, index) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "task-btn";
        btn.textContent = task;
        btn.dataset.index = index;
        btn.addEventListener("click", () => {
          currentTask = task;
          document
            .querySelectorAll(".task-btn")
            .forEach((b) => b.classList.remove("selected"));
          btn.classList.add("selected");
        });
        taskButtonsContainer.appendChild(btn);
      });

      // 最初の要素を選択状態に
      if (tasks.length > 0) {
        currentTask = tasks[0];
        const firstBtn = taskButtonsContainer.querySelector(".task-btn");
        if (firstBtn) firstBtn.classList.add("selected");
      }
    }

    renderTaskButtons();

    // 編集用テキストエリアに現在のリストを反映
    function fillTaskEditTextarea() {
      taskListInput.value = tasks.join("\n");
    }

    taskEditToggle.addEventListener("click", () => {
      const isOpen = taskEditArea.style.display === "block";
      if (isOpen) {
        taskEditArea.style.display = "none";
        taskEditToggle.textContent = "＋ 要素リストを編集";
      } else {
        fillTaskEditTextarea();
        taskEditArea.style.display = "block";
        taskEditToggle.textContent = "－ 編集を閉じる";
      }
    });

    saveTaskListBtn.addEventListener("click", () => {
      const lines = taskListInput.value
        .split("\n")
        .map((l) => l.trim())
        .filter((l) => l !== "");
      if (lines.length === 0) {
        alert("1つ以上の作業名を入力してください。");
        return;
      }
      tasks = lines;
      localStorage.setItem(TASKS_KEY, JSON.stringify(tasks));
      renderTaskButtons();
      taskEditArea.style.display = "none";
      taskEditToggle.textContent = "＋ 要素リストを編集";
      alert("要素リストを保存しました。");
    });

    // ---- タイマー処理 ----
    function formatDateTime(dt) {
      const pad = (n) => String(n).padStart(2, "0");
      return (
        dt.getFullYear() +
        "-" +
        pad(dt.getMonth() + 1) +
        "-" +
        pad(dt.getDate()) +
        " " +
        pad(dt.getHours()) +
        ":" +
        pad(dt.getMinutes()) +
        ":" +
        pad(dt.getSeconds())
      );
    }

    function formatDateOnly(dt) {
      const pad = (n) => String(n).padStart(2, "0");
      return (
        dt.getFullYear() +
        "-" +
        pad(dt.getMonth() + 1) +
        "-" +
        pad(dt.getDate())
      );
    }

    startBtn.addEventListener("click", () => {
      if (!currentTask) {
        alert("要素作業を選択してください。");
        return;
      }
      startTime = new Date();
      statusEl.textContent =
        "計測中…  開始：" + formatDateTime(startTime) + " / 要素：" + currentTask;
      startBtn.disabled = true;
      stopBtn.disabled = false;
    });

    stopBtn.addEventListener("click", () => {
      if (!startTime) return;

      const endTime = new Date();
      const diffSec = Math.round((endTime - startTime) / 1000);
      const dateStr = formatDateOnly(startTime);

      const worker = workerNameInput.value.trim() || "";

      const line =
        currentTask +
        "," +
        formatDateTime(startTime) +
        "," +
        formatDateTime(endTime) +
        "," +
        diffSec +
        "," +
        dateStr +
        "," +
        worker;

      if (logArea.value === "") {
        logArea.value =
          "要素作業,開始時刻,終了時刻,計測秒,計測日,作業者\n" + line;
      } else {
        logArea.value += "\n" + line;
      }

      statusEl.textContent =
        "記録しました: " +
        currentTask +
        " / " +
        formatDateTime(startTime) +
        " → " +
        formatDateTime(endTime) +
        " (" +
        diffSec +
        "秒)";
      startTime = null;
      startBtn.disabled = false;
      stopBtn.disabled = true;
    });

    // ---- 全コピー ----
    copyAllBtn.addEventListener("click", async () => {
      if (!logArea.value) return;
      try {
        await navigator.clipboard.writeText(logArea.value);
        alert("コピーしました。Excelに貼り付けできます。");
      } catch (e) {
        logArea.select();
        document.execCommand("copy");
        alert("コピーしました（古いブラウザモード）。");
      }
    });
  </script>
</body>
</html>
