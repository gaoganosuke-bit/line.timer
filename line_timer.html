<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ライン外作業タイマー記録</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --main-bg: #f5f7fb;
      --card-bg: #ffffff;
      --accent: #2563eb;
      --accent-soft: #e0ecff;
      --border: #d1d5db;
      --text-main: #111827;
      --text-sub: #6b7280;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, #e0ebff, #f5f7fb 45%, #f9fafb);
      color: var(--text-main);
    }

    .app {
      max-width: 560px;
      margin: 0 auto;
      padding: 16px 16px 40px;
    }

    h1 {
      font-size: 22px;
      font-weight: 700;
      margin: 4px 0 16px;
    }

    .version {
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 8px;
    }

    .card {
      background: rgba(255,255,255,0.9);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(15,23,42,0.08);
      padding: 14px 16px 16px;
      margin-bottom: 12px;
      border: 1px solid rgba(148,163,184,0.35);
      backdrop-filter: blur(10px);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    .badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
    }

    /* 要素作業ボタン群 */
    .task-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .task-btn {
      flex: 1 1 calc(50% - 4px);   /* 2列レイアウト（スマホ） */
      min-width: 140px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #f9fafb;
      padding: 10px 8px;
      font-size: 14px;
      text-align: center;
      cursor: pointer;
      transition: 0.15s all ease-out;
      box-shadow: 0 1px 2px rgba(15,23,42,0.05);
      user-select: none;
    }

    .task-btn span {
      display: inline-block;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .task-btn.active {
      background: linear-gradient(135deg,#2563eb,#4f46e5);
      color: #ffffff;
      border-color: transparent;
      box-shadow: 0 6px 18px rgba(37,99,235,0.4);
      transform: translateY(-1px);
    }

    .task-btn:active {
      transform: translateY(0);
      box-shadow: 0 3px 10px rgba(15,23,42,0.25);
    }

    /* 編集トグル */
    .edit-toggle {
      font-size: 11px;
      color: var(--accent);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--accent-soft);
      background: #f9fafb;
      cursor: pointer;
    }

    .edit-area {
      margin-top: 8px;
      display: none;
    }

    .edit-area textarea {
      width: 100%;
      min-height: 80px;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px 10px;
      font-size: 13px;
      resize: vertical;
    }

    .edit-buttons {
      margin-top: 6px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .btn-small {
      font-size: 12px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f9fafb;
      cursor: pointer;
    }

    .btn-small.primary {
      border-color: var(--accent);
      background: var(--accent);
      color: #fff;
    }

    label {
      font-size: 13px;
      color: var(--text-sub);
      display: block;
      margin-bottom: 4px;
    }

    input[type="text"] {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px 10px;
      font-size: 14px;
    }

    /* START / STOP */
    .timer-controls {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .btn-main {
      width: 100%;
      padding: 12px 16px;
      border-radius: 999px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.08em;
      cursor: pointer;
      transition: 0.15s all ease-out;
    }

    .btn-start {
      background: linear-gradient(135deg,#1d4ed8,#22c55e);
      color: #fff;
      box-shadow: 0 10px 24px rgba(22,163,74,0.45);
    }

    .btn-start:disabled {
      background: #e5e7eb;
      color: #9ca3af;
      box-shadow: none;
      cursor: not-allowed;
    }

    .btn-stop {
      background: #e5e7eb;
      color: #6b7280;
    }

    .btn-stop.running {
      background: linear-gradient(135deg,#f97316,#ef4444);
      color: #fff;
      box-shadow: 0 10px 24px rgba(239,68,68,0.45);
    }

    .btn-stop:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      box-shadow: none;
    }

    .status {
      font-size: 12px;
      color: var(--text-sub);
      margin-top: 4px;
    }

    textarea.log {
      width: 100%;
      min-height: 200px;
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      font-size: 13px;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }

    .copy-row {
      display: flex;
      justify-content: flex-end;
      margin-top: 8px;
    }

    .copy-btn {
      border-radius: 999px;
      border: 1px solid var(--accent);
      background: #fff;
      color: var(--accent);
      padding: 6px 14px;
      font-size: 12px;
      cursor: pointer;
    }

    @media (min-width: 720px) {
      .task-btn {
        flex: 1 1 calc(33.33% - 6px); /* PC で3列に */
      }
    }
  </style>
</head>
<body>
<div class="app">
  <h1>ライン外作業タイマー記録</h1>
  <div class="version">UI Ver. 2（ボタン＋要素編集対応）</div>

  <!-- 要素作業カード -->
  <div class="card">
    <div class="card-header">
      <div class="card-title">要素作業</div>
      <button id="editToggle" class="edit-toggle" type="button">
        ⚙ リスト編集
      </button>
    </div>

    <div id="taskButtons" class="task-buttons">
      <!-- JSでボタンを生成 -->
    </div>

    <!-- 編集エリア -->
    <div id="editArea" class="edit-area">
      <label>要素作業リスト（1行につき1つ）</label>
      <textarea id="taskEditor"></textarea>
      <div class="edit-buttons">
        <button id="editCancel" class="btn-small" type="button">キャンセル</button>
        <button id="editSave" class="btn-small primary" type="button">保存</button>
      </div>
    </div>
  </div>

  <!-- 作業者カード -->
  <div class="card">
    <div class="card-header">
      <div class="card-title">作業者名（任意）</div>
      <span class="badge">例：Aさん</span>
    </div>
    <input type="text" id="workerName" placeholder="Aさん">
  </div>

  <!-- タイマー操作 -->
  <div class="card">
    <div class="card-header">
      <div class="card-title">タイマー</div>
    </div>
    <div class="timer-controls">
      <button id="startBtn" class="btn-main btn-start" type="button">
        ▶ START（計測開始）
      </button>
      <button id="stopBtn" class="btn-main btn-stop" type="button" disabled>
        ■ STOP &amp; 記録
      </button>
    </div>
    <div id="statusText" class="status">待機中</div>
  </div>

  <!-- ログ表示 -->
  <div class="card">
    <div class="card-header">
      <div class="card-title">記録（このままExcelに貼り付け可）</div>
    </div>
    <textarea id="logArea" class="log" readonly></textarea>
    <div class="copy-row">
      <button id="copyBtn" class="copy-btn" type="button">
        全コピー（Excel貼り付け用）
      </button>
    </div>
  </div>
</div>

<script>
  // --- 初期データ ---
  const DEFAULT_TASKS = [
    "部品運搬",
    "品番確認",
    "棚番検索",
    "フォークリフト待ち",
    "製品仮置き",
    "手直し作業",
    "社員呼び出し"
  ];

  const STORAGE_KEY = "line_timer_tasks_v2";

  let tasks = [];
  let currentTask = "";
  let startTime = null;
  let timerRunning = false;

  const taskButtonsContainer = document.getElementById("taskButtons");
  const taskEditor = document.getElementById("taskEditor");
  const editArea = document.getElementById("editArea");
  const editToggle = document.getElementById("editToggle");
  const editSave = document.getElementById("editSave");
  const editCancel = document.getElementById("editCancel");
  const workerNameInput = document.getElementById("workerName");
  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");
  const logArea = document.getElementById("logArea");
  const statusText = document.getElementById("statusText");
  const copyBtn = document.getElementById("copyBtn");

  // 日付フォーマット
  function formatDateTime(d){
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const mi = String(d.getMinutes()).padStart(2,"0");
    const ss = String(d.getSeconds()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
  }

  function formatDate(d){
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  // 要素ボタンを描画
  function renderTaskButtons(){
    taskButtonsContainer.innerHTML = "";
    tasks.forEach((task, index) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "task-btn" + (task === currentTask ? " active" : "");
      btn.dataset.index = index;
      btn.innerHTML = `<span>${task}</span>`;
      btn.addEventListener("click", () => selectTask(task));
      taskButtonsContainer.appendChild(btn);
    });
  }

  function selectTask(task){
    currentTask = task;
    Array.from(taskButtonsContainer.children).forEach(btn => {
      btn.classList.toggle("active", btn.textContent.trim() === task);
    });
    statusText.textContent = `選択中の要素作業：${task}`;
  }

  // 編集モード切替
  function openEditMode(){
    editArea.style.display = "block";
    taskEditor.value = tasks.join("\n");
  }

  function closeEditMode(){
    editArea.style.display = "none";
  }

  editToggle.addEventListener("click", () => {
    if(editArea.style.display === "block"){
      closeEditMode();
    } else {
      openEditMode();
    }
  });

  editCancel.addEventListener("click", () => {
    closeEditMode();
  });

  editSave.addEventListener("click", () => {
    const lines = taskEditor.value
      .split("\n")
      .map(s => s.trim())
      .filter(s => s.length > 0);

    if(lines.length === 0){
      alert("1つ以上の要素作業を入力してください。");
      return;
    }
    tasks = lines;
    currentTask = tasks[0];
    localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
    renderTaskButtons();
    selectTask(currentTask);
    closeEditMode();
  });

  // START / STOP
  startBtn.addEventListener("click", () => {
    if(!currentTask){
      alert("要素作業を選択してください。");
      return;
    }
    startTime = new Date();
    timerRunning = true;
    startBtn.disabled = true;
    stopBtn.disabled = false;
    stopBtn.classList.add("running");
    statusText.textContent = `計測中：${currentTask}（開始 ${formatDateTime(startTime)}）`;
  });

  stopBtn.addEventListener("click", () => {
    if(!timerRunning || !startTime) return;
    const endTime = new Date();
    const diffSec = Math.round((endTime - startTime)/1000);
    const dateStr = formatDate(startTime);
    const worker = workerNameInput.value.trim() || "Aさん";

    // ヘッダー行がなければ先頭に付ける
    if(!logArea.value.includes("要素作業,開始時刻,終了時刻,計測秒,計測日,作業者")){
      logArea.value = "要素作業,開始時刻,終了時刻,計測秒,計測日,作業者\n";
    }

    const line = `${currentTask},${formatDateTime(startTime)},${formatDateTime(endTime)},${diffSec},${dateStr},${worker}`;
    logArea.value += line + "\n";

    statusText.textContent = `記録しました：${line}`;
    timerRunning = false;
    startTime = null;
    startBtn.disabled = false;
    stopBtn.disabled = true;
    stopBtn.classList.remove("running");
  });

  // 全コピー
  copyBtn.addEventListener("click", () => {
    logArea.select();
    document.execCommand("copy");
    statusText.textContent = "コピーしました（Excelに貼り付けてください）";
  });

  // 初期化
  function init(){
    const saved = localStorage.getItem(STORAGE_KEY);
    if(saved){
      try {
        tasks = JSON.parse(saved);
      } catch(e){
        tasks = [...DEFAULT_TASKS];
      }
    } else {
      tasks = [...DEFAULT_TASKS];
    }
    currentTask = tasks[0];
    renderTaskButtons();
    selectTask(currentTask);
  }

  init();
</script>
</body>
</html>
